<!-- Inspired from the Litle official example: https://cert01.securepaypage.litle.com/checkout/dontSeeCard.html -->
<html>
  <head>
    <title>Pay Page Checkout</title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="<%= secure_page_url %>/LitlePayPage/litle-api.js" type="text/javascript"></script>
    <script>
    $(document).ready(
      function() {
        function setLitleResponseFields(response) {
          document.getElementById('response_code').value = response.response;
          document.getElementById('response_message').value = response.message;
          document.getElementById('response_response_time').value = response.responseTime;
          document.getElementById('response_litle_txn_id').value = response.litleTxnId;
          document.getElementById('response_type').value = response.type;
        }

        function submitAfterLitle(response) {
          setLitleResponseFields(response);
          document.forms['form_checkout'].submit();
        }

        function timeoutOnLitle() {
          alert("We are experiencing technical difficulties. Please try your query again later.");
        }

        function onErrorAfterLitle(response) {
          setLitleResponseFields(response);
          if (response.response == '871') {
            alert("Invalid card number. Check and retry. (Not Mod10)");
          }
          else if (response.response == '872') {
            alert("Invalid card number. Check and retry. (Too short)");
          }
          else if (response.response == '873') {
            alert("Invalid card number. Check and retry. (Too long)");
          }
          else if (response.response == '874') {
            alert("Invalid card number. Check and retry. (Not a number)");
          }
          else if (response.response == '875') {
            alert("We are experiencing technical difficulties. Please try your query again later.");
          }
          else if (response.response == '876') {
            alert("Invalid card number. Check and retry. (Failure from Server)");
          }
          else if (response.response == '880') {
            alert("Invalid report group. Check and retry. (Failure from Server)");
          }
          else if (response.response == '889') {
            alert("We are experiencing technical difficulties. Please try your query again later.");
          }
          return false;
        }

        var formFields = {
          "accountNum": document.getElementById('cc_num'),
          "paypageRegistrationId": document.getElementById('response_paypage_registration_id'),
          "bin": document.getElementById('response_bin')
        };

        $("#submitId").click(
          function() {
            // Clear test fields
            setLitleResponseFields({"response":"", "message":""});

            var litleRequest = {
              "paypageId": document.getElementById("request_paypage_id").value,
              "reportGroup": document.getElementById("request_report_group").value,
              "orderId": document.getElementById("request_order_id").value,
              "id": document.getElementById("request_merchant_txn_id").value,
              "url": "<%= secure_page_url %>"
            };

            sendToLitle(litleRequest, formFields, submitAfterLitle, onErrorAfterLitle, timeoutOnLitle, 5000);
            return false;
          }
        );
      }
    );
    </script>
  </head>
  <body>
    <h2>Checkout Form</h2>
    <form method="post" id="form_checkout" name="form_checkout" action="/plugins/killbill-litle/checkout">
      <input type="hidden" id="kb_account_id" name="kb_account_id" value="<%= kb_account_id %>"/>

      <input type="hidden" id="request_paypage_id" name="request_paypage_id" value="<%= paypage_id %>"/>
      <input type="hidden" id="request_merchant_txn_id" name="request_merchant_txn_id" value="<%= merchant_txn_id %>"/>
      <input type="hidden" id="request_order_id" name="request_order_id" value="<%= order_id %>"/>
      <input type="hidden" id="request_report_group" name="request_report_group" value="<%= report_group %>"/>

      <table>
        <tr><td>First Name</td><td><input type="text" id="first_name" name="first_name" size="20" /></td></tr>
        <tr><td>Last Name</td><td><input type="text" id="last_name" name="last_name" size="20" /></td></tr>
        <tr><td>Credit Card</td><td><input type="text" id="cc_num" name="cc_num" size="20" /></td></tr>
        <tr><td>CVV</td><td><input type="text" id="cvv" name="cvv" size="5" /></td></tr>
        <tr><td>Exp Date</td><td><input type="text" id="exp_date" name="exp_date" size="5" /></td></tr>
        <tr><td>&nbsp;</td></tr>
        <tr><td></td><td align="right">
          <script>
          document.write('<button type="button" id="submitId" onclick="callLitle()">Check out with Pay Page</button>');
          </script>
          <noscript>
            <button type="button" id="submitId">Enable JavaScript!</button>
          </noscript>
        </td></tr>
      </table>

      <input type="hidden" id="response_paypage_registration_id" name="response_paypage_registration_id" readOnly="true" value=""/>
      <input type="hidden" id="response_bin" name="response_bin" readOnly="true"/>
      <input type="hidden" id="response_code" name="response_code" readOnly="true"/>
      <input type="hidden" id="response_message" name="response_message" readOnly="true"/>
      <input type="hidden" id="response_response_time" name="response_response_time" readOnly="true"/>
      <input type="hidden" id="response_type" name="response_type" readOnly="true"/>
      <input type="hidden" id="response_litle_txn_id" name="response_litle_txn_id" readOnly="true"/>
    </form>
  </body>
  <script>
  function callLitle() {
    if(typeof sendToLitle != 'function') {
      alert("We are experiencing technical difficulties. Please try your query again later (API unavailable).");
    }
  }
  </script>
</html>
